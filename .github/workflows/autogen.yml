name: Gen and update plists

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download IPAs
        uses: robinraju/release-downloader@v1
        with:
          tag: ${{ github.event.release.tag_name }}
          fileName: "*.ipa"
          out-file-path: ipa-assets

      - name: Get info and build plists
        run: |
          mkdir -p plists
          for ipa in ipa-assets/*.ipa; do
            echo "Processing $ipa"
            tmp=$(mktemp -d)
            unzip -p "$ipa" 'Payload/*.app/Info.plist' > "$tmp/Info.plist"

            BUNDLE_ID=$(plutil -extract CFBundleIdentifier xml1 -o - "$tmp/Info.plist" | xmllint --xpath 'string(//string)' -)
            VERSION=$(plutil -extract CFBundleShortVersionString xml1 -o - "$tmp/Info.plist" | xmllint --xpath 'string(//string)' -)
            NAME=$(plutil -extract CFBundleDisplayName xml1 -o - "$tmp/Info.plist" | xmllint --xpath 'string(//string)' -)

            PLIST_PATH="plists/${BUNDLE_ID}_${VERSION}.plist"

            cat > "$PLIST_PATH" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
 "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
 <key>items</key>
 <array>
  <dict>
   <key>assets</key>
   <array>
    <dict>
     <key>kind</key><string>software-package</string>
     <key>url</key><string>${{ github.event.release.assets_url }}/$(basename "$ipa")</string>
    </dict>
   </array>
   <key>metadata</key>
   <dict>
    <key>bundle-identifier</key><string>${BUNDLE_ID}</string>
    <key>bundle-version</key><string>${VERSION}</string>
    <key>kind</key><string>software</string>
    <key>title</key><string>${NAME}</string>
   </dict>
  </dict>
 </array>
</dict>
</plist>
EOF
            echo "Successfully generated $PLIST_PATH"
          done

      - name: Commit & push generated plists
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add plists/*.plist
          if git diff --cached --quiet; then
            echo "No new plists to commit."
          else
            git commit -m "chore: add OTA plists for ${{ github.event.release.tag_name }}"
            git push
          fi
